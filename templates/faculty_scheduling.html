{% extends "base.html" %}

{% block title %}Interview Scheduling{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
    .card {
        border: none;
        border-radius: 12px;
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease-in-out;
        background: #ffffff;
    }
    .card:hover {
        transform: scale(1.02);
    }
    .card-body {
        padding: 20px;
    }
    .rating-badge {
        font-size: 0.9rem;
        font-weight: bold;
        padding: 6px 12px;
        border-radius: 10px;
        display: inline-block;
    }
    .rating-high { background-color: #28a745; color: white; }  /* Green for high rating */
    .rating-medium { background-color: #ffc107; color: black; } /* Yellow for medium */
    .rating-low { background-color: #dc3545; color: white; }   /* Red for low */
    .btn-schedule {
        width: 100%;
        border: 3px solid var(--primary);
        background: white;
        color: var(--primary);
        border: none;
        padding: 10px;
        border-radius: 8px;
        transition: 0.3s;
    }
    .btn-schedule:hover {
        background: var(--primary);
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <h2 class="mb-4 text-center">üìù Shortlisted Applicants</h2>
    <div id="applicants-list" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        <!-- Applicants will be dynamically added here -->
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        let scheduledApplicants = new Set();  // Store applicants who have scheduled interviews

        // Fetch scheduled interviews first
        fetch('/get_scheduled_interviews')
            .then(response => response.json())
            .then(interviews => {
                interviews.forEach(interview => {
                    scheduledApplicants.add(interview.applicant_id);  // Store applicant_id
                });

                // Now fetch applicants
                fetch('/get_shortlisted_applicants')
                    .then(response => response.json())
                    .then(data => {
                        const container = document.getElementById("applicants-list");
                        container.innerHTML = ""; // Clear previous content

                        data.forEach(applicant => {
                            const card = document.createElement("div");
                            card.classList.add("col");
                            card.id = `applicant-${applicant.id}`;

                            // Check if this applicant has an interview scheduled
                            const isScheduled = scheduledApplicants.has(applicant.id);

                            let ratingClass = "rating-low";
                            if (applicant.rating >= 4) ratingClass = "rating-high";
                            else if (applicant.rating >= 3) ratingClass = "rating-medium";

                            const commentSection = applicant.rating < 4
                                ? `<p class="card-text"><strong>üó®Ô∏è Comment:</strong> ${applicant.comment || "No comment"}</p>`
                                : "";

                            card.innerHTML = `
                                <div class="card h-100">
                                    <div class="card-body">
                                        <h5 class="card-title">${applicant.name}</h5>
                                        <p class="card-text"><strong>‚≠ê Rating:</strong>
                                            <span class="rating-badge ${ratingClass}">${applicant.rating}</span>
                                        </p>
                                        ${commentSection}
                                        <input type="text" class="form-control datepicker mb-2"
                                            id="date-${applicant.id}"
                                            placeholder="${isScheduled ? 'Date Already Selected' : 'üìÖ Select Date'}"
                                            ${isScheduled ? 'disabled' : ''}>
                                        <button class="btn btn-schedule"
                                            onclick="scheduleInterview(${applicant.id})"
                                            style="background: ${isScheduled ? 'var(--secondary)' : 'var(--primary)'}; color: #ffffff;"
                                            ${isScheduled ? 'disabled' : ''}>
                                            ${isScheduled ? 'Interview Already Scheduled' : 'Schedule Interview'}
                                        </button>
                                    </div>
                                </div>
                            `;


                            container.appendChild(card);

                            flatpickr(`#date-${applicant.id}`, {
                                enableTime: true,
                                dateFormat: "Y-m-d H:i",
                            });
                        });
                    })
                    .catch(error => console.error("Error fetching applicants:", error));
            })
            .catch(error => console.error("Error fetching scheduled interviews:", error));
    });

    function scheduleInterview(applicantId) {
        const dateInput = document.getElementById(`date-${applicantId}`);
        const scheduleButton = document.querySelector(`#applicant-${applicantId} .btn-schedule`);
        const date = dateInput.value;

        if (!date) {
            alert("‚ö†Ô∏è Please select a date!");
            return;
        }

        fetch('/schedule_interview', {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ applicant_id: applicantId, date: date })
        }).then(response => response.json())
          .then(data => {
              if (data.success) {
                  alert(data.message);

                  // Disable only this applicant's button and date input
                  scheduleButton.disabled = true;
                  scheduleButton.innerText = "Interview Scheduled";
                  scheduleButton.style.background = "#ccc"; // Change button color
                  dateInput.disabled = true;
              } else {
                  alert("‚ùå Failed to schedule interview. Please try again.");
              }
          })
          .catch(error => console.error("Error scheduling interview:", error));
    }
</script>
{% endblock %}
